<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Dashboard - MealMap</title>
    <link rel="stylesheet" href="/css/shared-styles.css">
    <style>
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .dashboard-header {
            margin-bottom: 40px;
        }

        .dashboard-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 30px;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #111827;
        }

        .tab.active {
            color: #ff6b6b;
            border-bottom-color: #ff6b6b;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .restaurant-selector {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .restaurant-selector label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .restaurant-selector select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
        }

        .info-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .info-card h3 {
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #ff6b6b;
            color: white;
        }

        .btn-primary:hover {
            background: #ff5252;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.875rem;
        }

        .reservations-table {
            width: 100%;
            border-collapse: collapse;
        }

        .reservations-table th,
        .reservations-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .reservations-table th {
            background: #f9fafb;
            font-weight: 600;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-confirmed {
            background: #d1fae5;
            color: #065f46;
        }

        .status-cancelled {
            background: #fee2e2;
            color: #991b1b;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .menu-item-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
        }

        .menu-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .menu-item-title {
            font-weight: 600;
            font-size: 1.125rem;
        }

        .menu-item-price {
            color: #ff6b6b;
            font-weight: 600;
        }

        .menu-item-description {
            color: #6b7280;
            margin-bottom: 12px;
        }

        .menu-item-actions {
            display: flex;
            gap: 8px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #10b981;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            background: #f9fafb;
        }

        .filter-btn.active {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }
    </style>
</head>
<body>
    <div id="header-mount"></div>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>Owner Dashboard</h1>
            <p>Manage your restaurant, reservations, and menu</p>
        </div>

        <div class="restaurant-selector">
            <label for="restaurant-select">Select Restaurant:</label>
            <select id="restaurant-select">
                <option value="">Loading restaurants...</option>
            </select>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="info">Restaurant Info</button>
            <button class="tab" data-tab="reservations">Reservations</button>
            <button class="tab" data-tab="menu">Menu Management</button>
            <button class="tab" data-tab="promotions">Promotions</button>
        </div>

        <div id="tab-info" class="tab-content active">
            <div class="info-card">
                <h3>Restaurant Information</h3>
                <form id="restaurant-form">
                    <div class="form-group">
                        <label for="restaurant-name">Restaurant Name</label>
                        <input type="text" id="restaurant-name" name="Name" required>
                    </div>
                    <div class="form-group">
                        <label for="restaurant-description">Description</label>
                        <textarea id="restaurant-description" name="Description"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="restaurant-location" disabled>
                    </div>
                    <div class="form-group">
                        <label>Cuisine</label>
                        <input type="text" id="restaurant-cuisine" disabled>
                    </div>
                    <div class="form-group">
                        <label>Rating</label>
                        <input type="text" id="restaurant-rating" disabled>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        </div>

        <div id="tab-reservations" class="tab-content">
            <div class="info-card">
                <h3>Reservations</h3>
                <div class="filters">
                    <button class="filter-btn active" data-status="">All</button>
                    <button class="filter-btn" data-status="Pending">Pending</button>
                    <button class="filter-btn" data-status="Confirmed">Confirmed</button>
                    <button class="filter-btn" data-status="Cancelled">Cancelled</button>
                </div>
                <div id="reservations-container"></div>
            </div>
        </div>

        <div id="tab-menu" class="tab-content">
            <div class="info-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Menu Items</h3>
                    <button class="btn btn-primary" id="add-menu-item-btn">Add Menu Item</button>
                </div>
                <div id="menu-items-container"></div>
            </div>
        </div>

        <div id="tab-promotions" class="tab-content">
            <div class="info-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Promotions</h3>
                    <button class="btn btn-primary" id="add-promotion-btn">Add Promotion</button>
                </div>
                <div id="promotions-container"></div>
            </div>
        </div>
    </div>

    <div id="menu-item-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Add Menu Item</h3>
                <span class="close">&times;</span>
            </div>
            <form id="menu-item-form">
                <input type="hidden" id="menu-item-id">
                <div class="form-group">
                    <label for="item-name">Item Name</label>
                    <input type="text" id="item-name" name="Name" required>
                </div>
                <div class="form-group">
                    <label for="item-description">Description</label>
                    <textarea id="item-description" name="Description"></textarea>
                </div>
                <div class="form-group">
                    <label for="item-price">Price</label>
                    <input type="number" id="item-price" name="Price" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="item-image">Image URL</label>
                    <input type="text" id="item-image" name="image">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="item-available" name="IsAvailable" checked>
                        Available
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">Save Menu Item</button>
            </form>
        </div>
    </div>

    <div id="promotion-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="promotion-modal-title">Add Promotion</h3>
                <span class="close">&times;</span>
            </div>
            <form id="promotion-form">
                <input type="hidden" id="promotion-id">
                <div class="form-group">
                    <label for="promo-title">Title</label>
                    <input type="text" id="promo-title" name="Title" required>
                </div>
                <div class="form-group">
                    <label for="promo-description">Description</label>
                    <textarea id="promo-description" name="Description"></textarea>
                </div>
                <div class="form-group">
                    <label for="promo-discount">Discount (%)</label>
                    <input type="number" id="promo-discount" name="Discount" min="0" max="100" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="promo-valid-from">Valid From</label>
                    <input type="datetime-local" id="promo-valid-from" name="ValidFrom" required>
                </div>
                <div class="form-group">
                    <label for="promo-valid-to">Valid To</label>
                    <input type="datetime-local" id="promo-valid-to" name="ValidTo" required>
                </div>
                <button type="submit" class="btn btn-primary">Save Promotion</button>
            </form>
        </div>
    </div>

    <script src="/js/api-client.js"></script>
    <script src="/js/header.js"></script>
    <script>
        initializeHeader('#header-mount');
        
        let currentRestaurant = null;
        let currentFilter = '';

        document.addEventListener('DOMContentLoaded', () => {
            if (!api.isAuthenticated()) {
                window.location.href = '/login';
                return;
            }

            loadOwnerRestaurants();
            setupTabs();
            setupFilters();
            setupModal();
            setupPromotionModal();
        });

        async function loadOwnerRestaurants() {
            try {
                const userId = api.getCurrentUserId();
                const response = await fetch(`http://127.0.0.1:8000/owners/restaurants/${userId}`);
                const restaurants = await response.json();

                const select = document.getElementById('restaurant-select');
                
                if (restaurants.length === 0) {
                    select.innerHTML = '<option value="">No restaurants found. Contact admin to add your restaurant.</option>';
                    return;
                }

                select.innerHTML = restaurants.map(r => 
                    `<option value="${r.RestaurantID}">${r.Name}</option>`
                ).join('');

                if (restaurants.length > 0) {
                    currentRestaurant = restaurants[0].RestaurantID;
                    loadRestaurantData();
                }

                select.addEventListener('change', (e) => {
                    currentRestaurant = parseInt(e.target.value);
                    loadRestaurantData();
                });

            } catch (error) {
                console.error('Error loading restaurants:', error);
                alert('Failed to load your restaurants');
            }
        }

        async function loadRestaurantData() {
            if (!currentRestaurant) return;

            try {
                const response = await fetch(`http://127.0.0.1:8000/restaurants/${currentRestaurant}`);
                const restaurant = await response.json();

                document.getElementById('restaurant-name').value = restaurant.Name || '';
                document.getElementById('restaurant-description').value = restaurant.Description || '';
                document.getElementById('restaurant-location').value = restaurant.Location || '';
                document.getElementById('restaurant-cuisine').value = restaurant.Cuisine || '';
                document.getElementById('restaurant-rating').value = restaurant.Rating ? `${restaurant.Rating} (${restaurant.RatedBy} reviews)` : 'No ratings yet';

                loadReservations();
                loadMenuItems();
                loadPromotions();
            } catch (error) {
                console.error('Error loading restaurant data:', error);
            }
        }

        document.getElementById('restaurant-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                OwnerID: parseInt(api.getCurrentUserId()),
                Name: document.getElementById('restaurant-name').value,
                Description: document.getElementById('restaurant-description').value
            };

            try {
                const response = await fetch(`http://127.0.0.1:8000/owners/restaurant/${currentRestaurant}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('Restaurant updated successfully!');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error updating restaurant:', error);
                alert('Failed to update restaurant');
            }
        });

        async function loadReservations() {
            if (!currentRestaurant) return;

            try {
                const userId = api.getCurrentUserId();
                const statusParam = currentFilter ? `&status=${currentFilter}` : '';
                const response = await fetch(`http://127.0.0.1:8000/owners/restaurant/${currentRestaurant}/reservations?owner_id=${userId}${statusParam}`);
                const reservations = await response.json();

                const container = document.getElementById('reservations-container');
                
                if (reservations.length === 0) {
                    container.innerHTML = '<div class="empty-state"><h3>No reservations found</h3></div>';
                    return;
                }

                container.innerHTML = `
                    <table class="reservations-table">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Customer</th>
                                <th>Contact</th>
                                <th>Guests</th>
                                <th>Table</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reservations.map(r => `
                                <tr>
                                    <td>${new Date(r.ReservationTime).toLocaleString()}</td>
                                    <td>${r.CustomerFirstName} ${r.CustomerLastName}</td>
                                    <td>${r.CustomerEmail}<br>${r.CustomerPhone || 'N/A'}</td>
                                    <td>${r.GuestCount}</td>
                                    <td>Table ${r.TableNumber || r.TableID}</td>
                                    <td><span class="status-badge status-${r.Status.toLowerCase()}">${r.Status}</span></td>
                                    <td>
                                        ${r.Status === 'Pending' ? `
                                            <button class="btn btn-success btn-sm" onclick="confirmReservation(${r.ReservationID})">Confirm</button>
                                            <button class="btn btn-danger btn-sm" onclick="cancelReservation(${r.ReservationID})">Cancel</button>
                                        ` : r.Status === 'Confirmed' ? `
                                            <button class="btn btn-danger btn-sm" onclick="cancelReservation(${r.ReservationID})">Cancel</button>
                                        ` : 'No actions'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading reservations:', error);
            }
        }

        async function confirmReservation(reservationId) {
            try {
                const response = await fetch(`http://127.0.0.1:8000/owners/reservation/${reservationId}/confirm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ OwnerID: parseInt(api.getCurrentUserId()) })
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('Reservation confirmed!');
                    loadReservations();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error confirming reservation:', error);
                alert('Failed to confirm reservation');
            }
        }

        async function cancelReservation(reservationId) {
            if (!confirm('Are you sure you want to cancel this reservation?')) return;

            try {
                const response = await fetch(`http://127.0.0.1:8000/owners/reservation/${reservationId}/cancel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ OwnerID: parseInt(api.getCurrentUserId()) })
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('Reservation cancelled!');
                    loadReservations();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error cancelling reservation:', error);
                alert('Failed to cancel reservation');
            }
        }

        async function loadMenuItems() {
            if (!currentRestaurant) return;

            try {
                const response = await fetch(`http://127.0.0.1:8000/menu/${currentRestaurant}`);
                const menuData = await response.json();

                const container = document.getElementById('menu-items-container');
                
                if (!menuData || menuData.length === 0) {
                    container.innerHTML = '<div class="empty-state"><h3>No menu items found</h3><p>Add your first menu item to get started!</p></div>';
                    return;
                }

                const items = menuData.reduce((acc, item) => {
                    if (item.MenuItemID && !acc.find(i => i.MenuItemID === item.MenuItemID)) {
                        acc.push(item);
                    }
                    return acc;
                }, []);

                container.innerHTML = `
                    <div class="menu-grid">
                        ${items.map(item => `
                            <div class="menu-item-card">
                                <div class="menu-item-header">
                                    <div class="menu-item-title">${item.ItemName}</div>
                                    <div class="menu-item-price">$${parseFloat(item.Price).toFixed(2)}</div>
                                </div>
                                <div class="menu-item-description">${item.Description || 'No description'}</div>
                                <div class="menu-item-actions">
                                    <button class="btn btn-secondary btn-sm" onclick="editMenuItem(${item.MenuItemID})">Edit</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteMenuItem(${item.MenuItemID})">Delete</button>
                                    <label class="toggle-switch">
                                        <input type="checkbox" ${item.IsAvailable ? 'checked' : ''} onchange="toggleAvailability(${item.MenuItemID}, this.checked)">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading menu items:', error);
            }
        }

        async function deleteMenuItem(itemId) {
            if (!confirm('Are you sure you want to delete this menu item?')) return;

            try {
                const userId = api.getCurrentUserId();
                const response = await fetch(`http://127.0.0.1:8000/owners/menu/item/${itemId}?owner_id=${userId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('Menu item deleted!');
                    loadMenuItems();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting menu item:', error);
                alert('Failed to delete menu item');
            }
        }

        async function toggleAvailability(itemId, isAvailable) {
            try {
                const response = await fetch(`http://127.0.0.1:8000/owners/menu/item/${itemId}/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        OwnerID: parseInt(api.getCurrentUserId()),
                        IsAvailable: isAvailable
                    })
                });

                const result = await response.json();
                
                if (!response.ok) {
                    alert('Error: ' + result.error);
                    loadMenuItems();
                }
            } catch (error) {
                console.error('Error toggling availability:', error);
                alert('Failed to update availability');
                loadMenuItems();
            }
        }

        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
                });
            });
        }

        function setupFilters() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.status;
                    loadReservations();
                });
            });
        }

        async function loadPromotions() {
            if (!currentRestaurant) return;

            try {
                const response = await fetch(`http://127.0.0.1:8000/promotions/restaurant/${currentRestaurant}`);
                const promotions = await response.json();

                const container = document.getElementById('promotions-container');
                
                if (!promotions || promotions.length === 0) {
                    container.innerHTML = '<div class="empty-state"><h3>No promotions</h3><p>Create your first promotion to attract customers!</p></div>';
                    return;
                }

                container.innerHTML = `
                    <div style="display: grid; gap: 15px;">
                        ${promotions.map(p => `
                            <div class="info-card" style="padding: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <div>
                                        <h4 style="margin: 0 0 5px 0;">${p.Title}</h4>
                                        <p style="margin: 0; color: #666; font-size: 0.9rem;">${p.Description || 'No description'}</p>
                                    </div>
                                    <span style="background: #10b981; color: white; padding: 5px 10px; border-radius: 4px; font-weight: 600;">${p.Discount}% OFF</span>
                                </div>
                                <p style="margin: 10px 0; font-size: 0.9rem; color: #666;">
                                    ${new Date(p.ValidFrom).toLocaleDateString()} to ${new Date(p.ValidTo).toLocaleDateString()}
                                </p>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary btn-sm" onclick="editPromotion(${p.PromotionID})">Edit</button>
                                    <button class="btn btn-danger btn-sm" onclick="deletePromotion(${p.PromotionID})">Delete</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading promotions:', error);
            }
        }

        async function deletePromotion(promotionId) {
            if (!confirm('Are you sure you want to delete this promotion?')) return;

            try {
                const response = await fetch(`http://127.0.0.1:8000/promotions/delete/${promotionId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('Promotion deleted!');
                    loadPromotions();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting promotion:', error);
                alert('Failed to delete promotion');
            }
        }

        async function editPromotion(promotionId) {
            try {
                const response = await fetch(`http://127.0.0.1:8000/promotions/restaurant/${currentRestaurant}`);
                const promotions = await response.json();
                const promotion = promotions.find(p => p.PromotionID === promotionId);

                if (!promotion) {
                    alert('Promotion not found');
                    return;
                }

                document.getElementById('promotion-modal-title').textContent = 'Edit Promotion';
                document.getElementById('promotion-id').value = promotion.PromotionID;
                document.getElementById('promo-title').value = promotion.Title;
                document.getElementById('promo-description').value = promotion.Description || '';
                document.getElementById('promo-discount').value = promotion.Discount;
                
                const validFrom = new Date(promotion.ValidFrom).toISOString().slice(0, 16);
                const validTo = new Date(promotion.ValidTo).toISOString().slice(0, 16);
                document.getElementById('promo-valid-from').value = validFrom;
                document.getElementById('promo-valid-to').value = validTo;

                document.getElementById('promotion-modal').style.display = 'block';
            } catch (error) {
                console.error('Error loading promotion:', error);
                alert('Failed to load promotion');
            }
        }

        function setupModal() {
            const modal = document.getElementById('menu-item-modal');
            const closeBtn = modal.querySelector('.close');
            const addBtn = document.getElementById('add-menu-item-btn');
            const form = document.getElementById('menu-item-form');

            addBtn.addEventListener('click', () => {
                document.getElementById('modal-title').textContent = 'Add Menu Item';
                form.reset();
                document.getElementById('menu-item-id').value = '';
                modal.style.display = 'block';
            });

            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const itemId = document.getElementById('menu-item-id').value;
                const formData = {
                    OwnerID: parseInt(api.getCurrentUserId()),
                    Name: document.getElementById('item-name').value,
                    Description: document.getElementById('item-description').value,
                    Price: parseFloat(document.getElementById('item-price').value),
                    image: document.getElementById('item-image').value,
                    IsAvailable: document.getElementById('item-available').checked
                };

                try {
                    let response;
                    if (itemId) {
                        response = await fetch(`http://127.0.0.1:8000/owners/menu/item/${itemId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formData)
                        });
                    } else {
                        response = await fetch(`http://127.0.0.1:8000/owners/restaurant/${currentRestaurant}/menu/add`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formData)
                        });
                    }

                    const result = await response.json();
                    
                    if (response.ok) {
                        alert(itemId ? 'Menu item updated!' : 'Menu item added!');
                        modal.style.display = 'none';
                        loadMenuItems();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    console.error('Error saving menu item:', error);
                    alert('Failed to save menu item');
                }
            });
        }

        async function editMenuItem(itemId) {
            try {
                const response = await fetch(`http://127.0.0.1:8000/menu/item/${itemId}`);
                const item = await response.json();

                document.getElementById('modal-title').textContent = 'Edit Menu Item';
                document.getElementById('menu-item-id').value = item.MenuItemID;
                document.getElementById('item-name').value = item.Name;
                document.getElementById('item-description').value = item.Description || '';
                document.getElementById('item-price').value = item.Price;
                document.getElementById('item-image').value = item.image || '';
                document.getElementById('item-available').checked = item.IsAvailable;

                document.getElementById('menu-item-modal').style.display = 'block';
            } catch (error) {
                console.error('Error loading menu item:', error);
                alert('Failed to load menu item');
            }
        }

        function setupPromotionModal() {
            const modal = document.getElementById('promotion-modal');
            const closeBtn = modal.querySelector('.close');
            const addBtn = document.getElementById('add-promotion-btn');
            const form = document.getElementById('promotion-form');

            addBtn.addEventListener('click', () => {
                document.getElementById('promotion-modal-title').textContent = 'Add Promotion';
                form.reset();
                document.getElementById('promotion-id').value = '';
                modal.style.display = 'block';
            });

            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const promotionId = document.getElementById('promotion-id').value;
                
                // Convert datetime-local to MySQL format (YYYY-MM-DD HH:MM:SS)
                const validFromInput = document.getElementById('promo-valid-from').value;
                const validToInput = document.getElementById('promo-valid-to').value;
                const validFrom = validFromInput.replace('T', ' ') + ':00';
                const validTo = validToInput.replace('T', ' ') + ':00';
                
                const formData = {
                    RestaurantID: currentRestaurant,
                    Title: document.getElementById('promo-title').value,
                    Description: document.getElementById('promo-description').value,
                    Discount: parseFloat(document.getElementById('promo-discount').value),
                    ValidFrom: validFrom,
                    ValidTo: validTo
                };

                try {
                    let response;
                    if (promotionId) {
                        response = await fetch(`http://127.0.0.1:8000/promotions/update/${promotionId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formData)
                        });
                    } else {
                        response = await fetch('/api/promotions/create', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formData)
                        });
                    }

                    const result = await response.json();
                    
                    if (response.ok) {
                        alert(promotionId ? 'Promotion updated!' : 'Promotion created!');
                        modal.style.display = 'none';
                        loadPromotions();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    console.error('Error saving promotion:', error);
                    alert('Failed to save promotion');
                }
            });
        }

        window.confirmReservation = confirmReservation;
        window.cancelReservation = cancelReservation;
        window.deleteMenuItem = deleteMenuItem;
        window.toggleAvailability = toggleAvailability;
        window.editMenuItem = editMenuItem;
        window.deletePromotion = deletePromotion;
        window.editPromotion = editPromotion;
    </script>
</body>
</html>
